
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckIn Pro - Control de Asistencia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }
        .logo { font-size: 48px; margin-bottom: 20px; }
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .qr-section {
            background: #f7fafc;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px dashed #cbd5e0;
        }
        #qrCode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }
        .device-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #2d3748;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .button:hover { background: #5568d3; transform: translateY(-2px); }
        .button-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }
        .button-secondary:hover { background: #cbd5e0; }
        .scan-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }
        video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .history {
            margin-top: 30px;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }
        .history h3 {
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .record {
            padding: 12px;
            background: #f7fafc;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
        }
        .record.entrada { border-left-color: #48bb78; }
        .record.salida { border-left-color: #f56565; }
        .time { color: #718096; font-size: 12px; }
        .status {
            padding: 15px;
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            color: #16a34a;
            margin-bottom: 20px;
        }
        .error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "html5-qrcode": "https://esm.sh/html5-qrcode@^2.3.8",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body>
    <div class="container">
        <div class="logo">üë•</div>
        <h1>CheckIn Pro</h1>
        <p class="subtitle">Control de Asistencia con QR</p>

        <div class="device-info" id="deviceInfo">
            üì± Detectando dispositivo...
        </div>

        <div id="status"></div>

        <div class="qr-section">
            <h3 style="margin-bottom: 15px;">C√≥digo QR de Entrada/Salida</h3>
            <div id="qrCode"></div>
            <p style="color: #718096; margin-top: 15px; font-size: 12px;">
                Imprima o coloque este QR en la entrada
            </p>
        </div>

        <button class="button" onclick="app.startScanning()">üì± Escanear Empleado</button>
        <button class="button button-secondary" onclick="app.showSetup()">‚öôÔ∏è Configurar Terminal</button>
        <button class="button button-secondary" onclick="app.downloadReport()">üìä Descargar Reporte</button>

        <div class="scan-section" id="scanSection" style="display: none;">
            <h3>Escanear QR de Empleado</h3>
            <video id="video" playsinline></video>
            <p id="scanStatus" style="color: #718096; font-size: 12px;"></p>
            <button class="button button-secondary" onclick="app.stopScanning()">Detener Escaneo</button>
        </div>

        <div class="history" id="history">
            <h3>Registros del D√≠a</h3>
            <div id="records"></div>
        </div>
    </div>

    <script>
        const app = {
            deviceMAC: null,
            adminUser: null,
            records: [],
            scanning: false,
            video: null,
            canvas: null,

            async init() {
                this.getDeviceMAC();
                this.loadConfig();
                this.generateQR();
                this.loadRecords();
                this.updateUI();
            },

            getDeviceMAC() {
                // Nota: En navegadores modernos no se puede obtener la MAC real por seguridad
                // Se usa un identificador √∫nico basado en el navegador y dispositivo
                let mac = localStorage.getItem('device_mac');
                if (!mac) {
                    const nav = navigator.userAgent;
                    const timestamp = new Date().getTime();
                    mac = 'XX:' + Math.random().toString(16).substr(2, 2).toUpperCase() + ':' +
                          Math.random().toString(16).substr(2, 2).toUpperCase() + ':' +
                          Math.random().toString(16).substr(2, 2).toUpperCase() + ':' +
                          Math.random().toString(16).substr(2, 2).toUpperCase() + ':' +
                          Math.random().toString(16).substr(2, 2).toUpperCase();
                    localStorage.setItem('device_mac', mac);
                }
                this.deviceMAC = mac;
                this.updateDeviceInfo();
            },

            loadConfig() {
                const config = JSON.parse(localStorage.getItem('terminal_config') || '{}');
                this.adminUser = config.adminUser || 'Admin';
            },

            saveConfig() {
                localStorage.setItem('terminal_config', JSON.stringify({
                    adminUser: this.adminUser,
                    deviceMAC: this.deviceMAC
                }));
            },

            updateDeviceInfo() {
                const info = document.getElementById('deviceInfo');
                if (this.adminUser) {
                    info.innerHTML = `üì± Dispositivo: ${this.deviceMAC}<br>üë§ Administrador: ${this.adminUser}`;
                } else {
                    info.innerHTML = `üì± Dispositivo: ${this.deviceMAC}<br>‚ö†Ô∏è Terminal sin configurar`;
                }
            },

            generateQR() {
                const qrContent = `CHECKIN_MAIN_${this.deviceMAC}`;
                const qrDiv = document.getElementById('qrCode');
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, {
                    text: qrContent,
                    width: 250,
                    height: 250,
                    colorDark: '#667eea',
                    colorLight: '#ffffff'
                });
            },

            startScanning() {
                if (this.scanning) return;
                this.scanning = true;
                document.getElementById('scanSection').style.display = 'block';
                document.getElementById('scanStatus').textContent = 'Iniciando c√°mara...';

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        this.video = document.getElementById('video');
                        this.video.srcObject = stream;
                        this.video.onloadedmetadata = () => {
                            this.video.play();
                            this.scanQR();
                        };
                    })
                    .catch(err => {
                        document.getElementById('scanStatus').textContent = '‚ùå Error: ' + err.message;
                        this.scanning = false;
                    });
            },

            scanQR() {
                if (!this.scanning) return;
                
                this.canvas = this.canvas || document.createElement('canvas');
                const ctx = this.canvas.getContext('2d');
                const video = this.video;

                if (video.videoWidth) {
                    this.canvas.width = video.videoWidth;
                    this.canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (code) {
                        const data = code.data;
                        if (data.includes('emp_')) {
                            this.processCheckIn(data);
                        } else {
                            document.getElementById('scanStatus').textContent = '‚ùå QR inv√°lido. Escanee el QR de un empleado.';
                        }
                    } else {
                        document.getElementById('scanStatus').textContent = 'üîç Buscando c√≥digo QR...';
                    }
                }
                
                requestAnimationFrame(() => this.scanQR());
            },

            stopScanning() {
                this.scanning = false;
                if (this.video && this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                }
                document.getElementById('scanSection').style.display = 'none';
            },

            processCheckIn(qrData) {
                const employeeID = qrData.match(/emp_(\d+)/)?.[1] || 'desconocido';
                const employeeName = qrData.match(/name_([^_]+)/)?.[1] || 'Empleado ' + employeeID;
                
                // Determinar si es entrada o salida
                const lastRecord = this.records
                    .filter(r => r.employeeID === employeeID)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                const action = (!lastRecord || lastRecord.action === 'SALIDA') ? 'ENTRADA' : 'SALIDA';

                const record = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString('es-AR'),
                    deviceMAC: this.deviceMAC,
                    adminUser: this.adminUser,
                    employeeID: employeeID,
                    employeeName: decodeURIComponent(employeeName).replace(/_/g, ' '),
                    action: action
                };

                this.records.push(record);
                this.saveRecords();
                
                this.stopScanning();
                this.showStatus(`‚úÖ ${record.employeeName} registrado ${action === 'ENTRADA' ? 'ENTRADA' : 'SALIDA'}`, false);
                this.updateUI();
            },

            showStatus(message, isError = false) {
                const status = document.getElementById('status');
                status.innerHTML = `<div class="status ${isError ? 'error' : ''}">${message}</div>`;
                setTimeout(() => { status.innerHTML = ''; }, 3000);
            },

            showSetup() {
                const name = prompt('Ingrese el nombre del administrador de esta terminal:');
                if (name) {
                    this.adminUser = name;
                    this.saveConfig();
                    this.updateDeviceInfo();
                    this.showStatus(`‚úÖ Terminal configurada para: ${name}`);
                }
            },

            loadRecords() {
                const today = new Date().toLocaleDateString('es-AR');
                const saved = JSON.parse(localStorage.getItem('checkin_records_' + today) || '[]');
                this.records = saved;
            },

            saveRecords() {
                const today = new Date().toLocaleDateString('es-AR');
                localStorage.setItem('checkin_records_' + today, JSON.stringify(this.records));
            },

            updateUI() {
                const recordsDiv = document.getElementById('records');
                if (this.records.length === 0) {
                    recordsDiv.innerHTML = '<p style="color: #718096;">Sin registros a√∫n</p>';
                    return;
                }

                recordsDiv.innerHTML = this.records
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(r => `
                        <div class="record ${r.action.toLowerCase()}">
                            <strong>${r.employeeName}</strong> - ${r.action}
                            <div class="time">${r.timestamp} | MAC: ${r.deviceMAC}</div>
                        </div>
                    `).join
